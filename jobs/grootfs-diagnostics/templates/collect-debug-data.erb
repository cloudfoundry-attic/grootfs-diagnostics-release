#!/bin/bash

collect_debug_info() {
  local dstate_pids=$1
  local dstate_processes=$2
  local debug_data_path=$3

  echo "$dstate_processes" > ${debug_data_path}/dstate-processes
  get_app_data $debug_data_path
  get_system_info $debug_data_path

  tar zcf ${debug_data_path}.tar.gz ${debug_data_path}
}

get_app_data() {
  local debug_data_path=$1
  /var/vcap/packages/badapps/bin/badapps | python -mjson.tool > "${debug_data_path}/applications.json"
}

get_system_info() {
  local debug_data_path=$1

  mpstat -P ALL > ${debug_data_path}/mpstat
  vmstat > ${debug_data_path}/vmstat
  dmesg > ${debug_data_path}/dmesg
  iostat -xz > ${debug_data_path}/iostat
  uptime > ${debug_data_path}/uptime
  pidstat > ${debug_data_path}/pidstat
}

collect_debug_info "$1" "$2" "$3"
