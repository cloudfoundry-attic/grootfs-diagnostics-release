#!/bin/bash

BIN_PATH=/var/vcap/jobs/grootfs-diagnostics/bin
DATA_PATH=/var/vcap/data/grootfs-diagnostics
TRACE_DAT=${DATA_PATH}/trace.dat
RUN_PATH=/var/vcap/sys/run/grootfs-diagnostics
LAST_RUN_PIDS=${RUN_PATH}/last_pids
PID_FILE=${RUN_PATH}/grootfs-diagnostics.pid
export PATH=/var/vcap/packages/trace-cmd/bin:$PATH

mkdir -p $DATA_PATH
mkdir -p $RUN_PATH

echo $$ > $PID_FILE

<% if !p('grootfs-diagnostics.disabled') %>
source ${BIN_PATH}/no-action
<% else %>
source ${BIN_PATH}/xfs-trace
<% end %>

source ${BIN_PATH}/report-dstate

start_trace

touch ${LAST_RUN_PIDS}
while true
do
  dstate_detected=false
  check_max_trace_logs_reached

  current_pids=$(ps axho pid,state | grep 'D' | cut -d D -f1)
  for pid in $current_pids
  do
    if grep $pid $LAST_RUN_PIDS
    then

      dstate_detected=true
      continue

    fi
  done

  if $dstate_detected
  then
    extract_trace_data
    send_event_to_datadog
  fi

  echo $current_pids > $LAST_RUN_PIDS

  sleep <%= p("grootfs-diagnostics.interval") %>
done
