#!/bin/bash

report_dstate() {
  local output_path=$1
  local cell_name=$2
  local cell_id=$3

  tar zcf ${output_path}.tar.gz -C ${output_path}/.. $(basename ${output_path})

  send_event_to_datadog "${output_path}.tar.gz" "$cell_name" "$cell_id"

  rm -rf $output_path
}

send_event_to_datadog() {
  local tar_path=$1
  local cell_name=$2
  local cell_id=$3

  /var/vcap/packages/laika/bin/laika --datadog-api-key=<%= p("grootfs-diagnostics.datadog_api_key") %>  \
    --datadog-app-key=<%= p("grootfs-diagnostics.datadog_app_key") %>  \
    --prefix=grootfs-diagnostics \
    --event-title="grootfs-diagnostics: d-state detected" \
    --event-message="{\"cell_name\":\"${cell_name}\",\"cell_id\":\"${cell_id}\",\"logs_path\":\"${tar_path}\"}" \
    --event-tag="grootfs-dstate"
}
